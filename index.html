<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bristol Improv Calendar ‚Äî Beta</title>
  <meta name="description" content="What's on in Bristol improv. Shows, workshops, and jams across the city.">
  
  <meta property="og:title" content="Bristol Improv Calendar ‚Äî Beta">
  <meta property="og:description" content="What's on in Bristol improv. Shows, workshops, and jams across the city.">
  <meta property="og:type" content="website">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // ============================================
    // CONFIGURATION
    // ============================================
    
    const EVENTS_JSON_URL = './events.json';
    const USE_SAMPLE_DATA = false;
    const MIN_YEAR = 2026;
    const MIN_MONTH = 0;
    const KOFI_URL = 'https://ko-fi.com/kaluuja';
    const FEATURE_REQUEST_URL = 'https://forms.gle/J8AJqsfRbz6m1Gbf7';
    
    const SAMPLE_EVENTS = [
      { date: '2026-01-25', title: 'The BLANK who BLANKED me', venue: 'Bristol Improv Theatre', time: '19:00‚Äì20:00', type: 'show', url: '#' },
      { date: '2026-01-28', title: 'Lily Maryon', venue: 'Bristol Improv Theatre', time: '19:30‚Äì21:30', type: 'show', url: '#' },
      { date: '2026-01-28', title: 'Biscuit Barrel', venue: 'Bristol Improv Theatre', time: '14:00‚Äì15:00', type: 'show', url: '#' },
      { date: '2026-01-28', title: 'Luke McQueen', venue: 'Bristol Improv Theatre', time: '21:00‚Äì22:00', type: 'show', url: '#' },
      { date: '2026-01-28', title: 'Open Jam Night', venue: 'Hen & Chicken', time: '19:30‚Äì21:30', type: 'jam', url: '#' },
      { date: '2026-01-30', title: 'Belltower', venue: 'Bristol Improv Theatre', time: '19:30‚Äì21:30', type: 'show', url: '#' },
      { date: '2026-01-31', title: 'Antics Joke Show', venue: 'Bristol Improv Theatre', time: '19:30‚Äì21:30', type: 'show', url: '#' },
      { date: '2026-02-05', title: 'Live in da Hive', venue: 'PRSC', time: '19:00‚Äì22:30', type: 'show', url: '#' },
      { date: '2026-02-06', title: 'The Bish Bosh Bash', venue: 'Bristol Improv Theatre', time: '19:30‚Äì21:30', type: 'show', url: '#' },
      { date: '2026-02-11', title: 'Wednesday Night Improv', venue: 'Hen & Chicken', time: '19:30‚Äì21:30', type: 'show', url: '#' },
      { date: '2026-02-14', title: 'From HELL YEAH! with love', venue: 'Bristol Improv Theatre', time: '19:30‚Äì21:30', type: 'show', url: '#' },
      { date: '2026-02-25', title: 'Tales From The Wasteland', venue: 'Hen & Chicken', time: '19:30‚Äì22:00', type: 'show', url: '#' },
    ];
    
    // ============================================
    // ROADMAP MODAL
    // ============================================
    
    const RoadmapModal = ({ isOpen, onClose, colors }) => {
      if (!isOpen) return null;
      
      const RoadmapItem = ({ done, children }) => (
        <li style={{ 
          marginBottom: '0.6rem',
          display: 'flex',
          alignItems: 'flex-start',
          gap: '0.6rem'
        }}>
          <span style={{ 
            flexShrink: 0,
            width: '22px',
            height: '22px',
            borderRadius: '5px',
            background: done ? colors.sage : 'transparent',
            border: done ? 'none' : `2px solid ${colors.textMuted}`,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '0.75rem',
            color: 'white',
            marginTop: '1px'
          }}>
            {done && '‚úì'}
          </span>
          <span style={{ 
            textDecoration: done ? 'line-through' : 'none',
            color: done ? colors.textMuted : colors.text,
            fontSize: '0.9rem',
            lineHeight: 1.4
          }}>
            {children}
          </span>
        </li>
      );
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>üó∫Ô∏è Roadmap</h2>
              <button className="modal-close" onClick={onClose}>‚úï</button>
            </div>
            <div className="modal-body">
              <p className="roadmap-intro">
                This calendar is a work in progress! Here's what's been done and what's coming next.
              </p>
              
              <div className="roadmap-section">
                <h3>‚ö° Core Functionality</h3>
                <ul>
                  <RoadmapItem done={true}>Add filters and search</RoadmapItem>
                  <RoadmapItem done={true}>'Swipe' between months on mobile</RoadmapItem>
                  <RoadmapItem done={true}>Shows, workshops, drop-ins, jams added</RoadmapItem>
                  <RoadmapItem done={false}>Downloadable calendar feed</RoadmapItem>
                  <RoadmapItem done={false}>Email newsletter for weekly updates</RoadmapItem>
                </ul>
              </div>
              
              <div className="roadmap-section">
                <h3>üé≠ Events</h3>
                <ul>
                  <RoadmapItem done={true}>Added 15 venues</RoadmapItem>
                  <RoadmapItem done={true}>Added additional ticket websites</RoadmapItem>
                </ul>
              </div>
              
              <div className="roadmap-section">
                <h3>üé® Design & Experience</h3>
                <ul>
                  <RoadmapItem done={true}>Event type colour-coding</RoadmapItem>
                  <RoadmapItem done={true}>Event type icons for colour-blind</RoadmapItem>
                  <RoadmapItem done={true}>Dark mode</RoadmapItem>
                  <RoadmapItem done={false}>List view option</RoadmapItem>
                  <RoadmapItem done={false}>Save favourite events</RoadmapItem>
                </ul>
              </div>
              
              <div className="roadmap-section">
                <h3>üîÆ Future Ideas</h3>
                <ul>
                  <RoadmapItem done={false}>Improv type tags? (shortform, longform, musical, narrative, etc.)</RoadmapItem>
                  <RoadmapItem done={false}>Performer and group profiles/socials</RoadmapItem>
                  <RoadmapItem done={false}>User accounts and personalisation</RoadmapItem>
                  <RoadmapItem done={false}>Event reminders/New events added</RoadmapItem>
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // SETTINGS MODAL
    // ============================================
    
    const SettingsModal = ({ isOpen, onClose, colors, darkMode, setDarkMode, onOpenRoadmap, lastUpdated, formatLastUpdated }) => {
      if (!isOpen) return null;
      
      const FEATURE_REQUEST_URL = 'https://forms.gle/62psP8V9JF88Kdnz8';
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content settings-modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2>‚öôÔ∏è Settings</h2>
              <button className="modal-close" onClick={onClose}>‚úï</button>
            </div>
            <div className="modal-body">
              
              {/* Dark Mode Toggle */}
              <div className="settings-section">
                <div className="settings-row">
                  <div className="settings-label">
                    <span className="settings-icon">{darkMode ? 'üåô' : '‚òÄÔ∏è'}</span>
                    <span>{darkMode ? 'Dark Mode' : 'Light Mode'}</span>
                  </div>
                  <button 
                    className={`toggle-btn ${darkMode ? 'active' : ''}`}
                    onClick={() => setDarkMode(!darkMode)}
                    aria-label="Toggle dark mode"
                  >
                    <span className="toggle-slider"></span>
                  </button>
                </div>
              </div>
              
              {/* Roadmap Link */}
              <div className="settings-section">
                <button 
                  className="settings-link-btn"
                  onClick={() => { onClose(); onOpenRoadmap(); }}
                >
                  <span className="settings-icon">üó∫Ô∏è</span>
                  <span>View Roadmap</span>
                  <span className="settings-arrow">‚Üí</span>
                </button>
              </div>
              
              {/* Feature Request */}
              <div className="settings-section settings-cta">
                <p className="settings-cta-text">Got suggestions? Ideas for new features?</p>
                <a href={FEATURE_REQUEST_URL} target="_blank" rel="noopener noreferrer" className="cta-button">
                  üí° Submit your ideas
                </a>
              </div>
              
              {/* Last Updated */}
              {lastUpdated && (
                <div className="settings-footer">
                  <span className="settings-updated">Calendar last updated: {formatLastUpdated(lastUpdated)}</span>
                </div>
              )}
              
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // MAIN COMPONENT
    // ============================================

    const BristolImprovCalendar = () => {
      const [selectedDate, setSelectedDate] = useState(null);
      const [venueFilter, setVenueFilter] = useState('all');
      const [typeFilter, setTypeFilter] = useState('all');
      const [searchQuery, setSearchQuery] = useState('');
      const [showSearchResults, setShowSearchResults] = useState(false);
      const [events, setEvents] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [showRoadmap, setShowRoadmap] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [darkMode, setDarkMode] = useState(() => {
        // Check localStorage for saved preference
        if (typeof window !== 'undefined') {
          const saved = localStorage.getItem('bristolImprovDarkMode');
          return saved === 'true';
        }
        return false;
      });
      const [lastUpdated, setLastUpdated] = useState(null);
      const [viewYear, setViewYear] = useState(new Date().getFullYear());
      const [viewMonth, setViewMonth] = useState(new Date().getMonth());
      
      const controlsRef = useRef(null);
      const calendarRef = useRef(null);
      const touchStartX = useRef(null);
      const touchStartY = useRef(null);
      
      // Save dark mode preference
      useEffect(() => {
        localStorage.setItem('bristolImprovDarkMode', darkMode.toString());
      }, [darkMode]);
      
      // Light and dark mode color schemes
      const lightColors = {
        cream: '#F4F1DE',
        terracotta: '#E07A5F',
        navy: '#3D405B',
        sage: '#81B29A',
        sand: '#F2CC8F',
        bg: '#F4F1DE',
        cardBg: '#FFFFFF',
        text: '#3D405B',
        textMuted: '#3D405B80',
        border: '#F4F1DE',
      };
      
      const darkColors = {
        cream: '#2A2D3E',
        terracotta: '#E07A5F',
        navy: '#E8E8E8',
        sage: '#81B29A',
        sand: '#F2CC8F',
        bg: '#1A1C28',
        cardBg: '#2A2D3E',
        text: '#E8E8E8',
        textMuted: '#E8E8E880',
        border: '#3D405B',
      };
      
      const colors = darkMode ? darkColors : lightColors;
      
      // Normalize event type to handle variations like 'drop-in', 'Drop-in', 'dropin', etc.
      const normalizeEventType = (type) => {
        if (!type) return 'show';
        const t = type.toLowerCase().replace(/[-_\s]/g, '');
        if (t === 'dropin' || t === 'dropins') return 'dropin';
        if (t === 'workshop' || t === 'workshops' || t === 'class' || t === 'classes') return 'workshop';
        if (t === 'jam' || t === 'jams') return 'jam';
        if (t === 'show' || t === 'shows') return 'show';
        return 'show'; // default
      };
      
      // Event type styles with colors and emoji circles for dropdown
      const eventTypeStyles = {
        'show': { color: colors.terracotta, label: 'Shows', icon: 'üé≠', dot: 'üî¥' },
        'workshop': { color: colors.sage, label: 'Workshops', icon: 'üìö', dot: 'üü¢' },
        'jam': { color: colors.sand, label: 'Jams', icon: 'üé≤', dot: 'üü°' },
        'dropin': { color: '#7B68A6', label: 'Drop-ins', icon: 'üö™', dot: 'üü£' },
      };
      
      const venueStyles = {
        'Bristol Improv Theatre': { color: colors.terracotta, bg: `${colors.terracotta}18`, group: 'Bristol Improv Theatre', order: 1 },
        'Hen & Chicken': { color: colors.sand, bg: `${colors.sand}25`, group: 'Hen & Chicken', order: 2 },
        'Hen & Chicken (Chicken Shed)': { color: colors.sand, bg: `${colors.sand}25`, group: 'Hen & Chicken', order: 2 },
        'Hen & Chicken (Studio)': { color: colors.sand, bg: `${colors.sand}25`, group: 'Hen & Chicken', order: 2 },
        'PRSC': { color: colors.sage, bg: `${colors.sage}20`, group: 'PRSC', order: 3 },
        'SPACE at PRSC': { color: colors.sage, bg: `${colors.sage}20`, group: 'PRSC', order: 3 },
        'Wardrobe Theatre': { color: '#7B68A6', bg: '#7B68A618', group: 'Wardrobe Theatre', order: 4 },
        'Tobacco Factory': { color: '#8B6F47', bg: '#8B6F4715', group: 'Other', order: 5 },
        'Bristol Beacon': { color: '#C4A35A', bg: '#C4A35A15', group: 'Other', order: 5 },
      };
      
      // Venue groups for filter dropdown (in display order)
      const venueGroups = [
        { key: 'Bristol Improv Theatre', label: 'Bristol Improv Theatre' },
        { key: 'Hen & Chicken', label: 'Hen & Chicken' },
        { key: 'PRSC', label: 'PRSC' },
        { key: 'Wardrobe Theatre', label: 'Wardrobe Theatre' },
        { key: 'Other', label: 'Other' },
      ];
      
      const isEveningEvent = (timeStr) => {
        if (!timeStr) return true;
        const match = timeStr.match(/^(\d{1,2}):?(\d{2})?/);
        if (match) {
          const hour = parseInt(match[1], 10);
          return hour >= 17;
        }
        return true;
      };
      
      // Parse time string to get start and end times in minutes from midnight
      const parseEventTimes = (timeStr) => {
        if (!timeStr) return null;
        // Handle formats like "19:00‚Äì21:00", "19:00-21:00", "7pm - 9pm", "19:00"
        const timeRange = timeStr.replace(/\s/g, '').split(/[‚Äì\-]/);
        
        const parseTime = (t) => {
          if (!t) return null;
          // Handle "7pm", "19:00", "7:30pm" formats
          const pmMatch = t.toLowerCase().includes('pm');
          const amMatch = t.toLowerCase().includes('am');
          const cleaned = t.replace(/[apm]/gi, '');
          const parts = cleaned.split(':');
          let hour = parseInt(parts[0], 10);
          const mins = parts[1] ? parseInt(parts[1], 10) : 0;
          
          if (pmMatch && hour < 12) hour += 12;
          if (amMatch && hour === 12) hour = 0;
          
          return hour * 60 + mins;
        };
        
        const start = parseTime(timeRange[0]);
        const end = timeRange[1] ? parseTime(timeRange[1]) : (start ? start + 120 : null); // Default 2 hour duration
        
        return start !== null ? { start, end } : null;
      };
      
      // Check if two events overlap in time
      const eventsOverlap = (event1, event2) => {
        const times1 = parseEventTimes(event1.time);
        const times2 = parseEventTimes(event2.time);
        
        if (!times1 || !times2) return false; // Can't determine, assume no overlap
        
        // Events overlap if one starts before the other ends
        return times1.start < times2.end && times2.start < times1.end;
      };
      
      // Check if any events in a list have overlapping times
      const hasOverlappingEvents = (eventsList) => {
        if (eventsList.length < 2) return false;
        
        for (let i = 0; i < eventsList.length; i++) {
          for (let j = i + 1; j < eventsList.length; j++) {
            if (eventsOverlap(eventsList[i], eventsList[j])) {
              return true;
            }
          }
        }
        return false;
      };
      
      useEffect(() => {
        const fetchEvents = async () => {
          if (USE_SAMPLE_DATA) {
            setTimeout(() => { setEvents(SAMPLE_EVENTS); setLoading(false); }, 300);
            return;
          }
          try {
            setLoading(true);
            const response = await fetch(EVENTS_JSON_URL + `?t=${Date.now()}`);
            if (!response.ok) throw new Error(`Failed: ${response.status}`);
            const data = await response.json();
            let eventsData = data.events || data.record?.events || data;
            setEvents(Array.isArray(eventsData) ? eventsData : []);
            setLastUpdated(data.lastUpdated || data.record?.lastUpdated);
            setError(null);
          } catch (err) {
            setEvents(SAMPLE_EVENTS);
            setError(`Using sample data`);
          } finally {
            setLoading(false);
          }
        };
        fetchEvents();
      }, []);
      
      useEffect(() => {
        const handleClick = (e) => {
          if (controlsRef.current && !controlsRef.current.contains(e.target)) {
            setShowSearchResults(false);
          }
        };
        document.addEventListener('mousedown', handleClick);
        return () => document.removeEventListener('mousedown', handleClick);
      }, []);
      
      const today = new Date();
      const todayYear = today.getFullYear();
      const todayMonth = today.getMonth();
      const todayDate = today.getDate();
      
      const maxEventDate = useMemo(() => {
        if (events.length === 0) return { year: todayYear, month: todayMonth };
        let maxY = MIN_YEAR, maxM = MIN_MONTH;
        events.forEach(e => {
          const d = new Date(e.date);
          if (d.getFullYear() > maxY || (d.getFullYear() === maxY && d.getMonth() > maxM)) {
            maxY = d.getFullYear();
            maxM = d.getMonth();
          }
        });
        return { year: maxY, month: maxM };
      }, [events]);
      
      const canGoBack = viewYear > MIN_YEAR || (viewYear === MIN_YEAR && viewMonth > MIN_MONTH);
      const canGoForward = viewYear < maxEventDate.year || (viewYear === maxEventDate.year && viewMonth < maxEventDate.month);
      const isCurrentMonth = viewYear === todayYear && viewMonth === todayMonth;
      
      const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
      const firstDay = new Date(viewYear, viewMonth, 1).getDay();
      const startDay = firstDay === 0 ? 6 : firstDay - 1;
      
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const monthShort = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      
      const goToPrevMonth = () => {
        if (!canGoBack) return;
        setSelectedDate(null);
        setViewMonth(viewMonth === 0 ? 11 : viewMonth - 1);
        setViewYear(viewMonth === 0 ? viewYear - 1 : viewYear);
      };
      
      const goToNextMonth = () => {
        if (!canGoForward) return;
        setSelectedDate(null);
        setViewMonth(viewMonth === 11 ? 0 : viewMonth + 1);
        setViewYear(viewMonth === 11 ? viewYear + 1 : viewYear);
      };
      
      const goToToday = () => {
        setSelectedDate(null);
        setViewYear(todayYear);
        setViewMonth(todayMonth);
      };
      
      // Touch handlers for swipe navigation on mobile
      const handleTouchStart = (e) => {
        touchStartX.current = e.touches[0].clientX;
        touchStartY.current = e.touches[0].clientY;
      };
      
      const handleTouchEnd = (e) => {
        if (touchStartX.current === null || touchStartY.current === null) return;
        
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;
        
        const deltaX = touchEndX - touchStartX.current;
        const deltaY = touchEndY - touchStartY.current;
        
        // Only trigger swipe if horizontal movement is greater than vertical
        // and the swipe is at least 50px
        const minSwipeDistance = 50;
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
          if (deltaX > 0) {
            // Swiped right - go to previous month
            goToPrevMonth();
          } else {
            // Swiped left - go to next month
            goToNextMonth();
          }
        }
        
        touchStartX.current = null;
        touchStartY.current = null;
      };
      
      const getVenueGroup = (venue) => {
        const style = venueStyles[venue];
        if (style) return style.group;
        // Check if venue starts with known prefixes
        if (venue.startsWith('Hen & Chicken')) return 'Hen & Chicken';
        if (venue.includes('PRSC')) return 'PRSC';
        // Everything else is 'Other'
        return 'Other';
      };
      
      const getVenueInfo = (venue) => venueStyles[venue] || 
        { color: colors.navy, bg: `${colors.navy}15`, group: 'Other' };
      
      const getEventsForDate = (date) => {
        return events.filter(e => {
          const d = new Date(e.date);
          if (d.getMonth() !== viewMonth || d.getFullYear() !== viewYear || d.getDate() !== date) return false;
          const group = getVenueGroup(e.venue);
          const matchVenue = venueFilter === 'all' || group === venueFilter;
          
          const normalizedType = normalizeEventType(e.type);
          
          let matchType = true;
          if (typeFilter === 'daytime') {
            matchType = !isEveningEvent(e.time);
          } else if (typeFilter === 'evening') {
            matchType = isEveningEvent(e.time);
          } else if (typeFilter !== 'all') {
            matchType = normalizedType === typeFilter;
          }
          
          return matchVenue && matchType;
        });
      };
      
      // Get event type counts for a date (for dot display)
      const getEventTypeCounts = (date) => {
        const dateEvents = getEventsForDate(date);
        const counts = {};
        dateEvents.forEach(e => {
          const type = normalizeEventType(e.type);
          counts[type] = (counts[type] || 0) + 1;
        });
        return counts;
      };
      
      const searchResults = useMemo(() => {
        if (!searchQuery.trim()) return [];
        const q = searchQuery.toLowerCase();
        return events.filter(e => 
          e.title.toLowerCase().includes(q) || 
          e.venue.toLowerCase().includes(q) ||
          (e.description?.toLowerCase().includes(q))
        ).slice(0, 8);
      }, [searchQuery, events]);
      
      const handleSearchSelect = (event) => {
        const d = new Date(event.date);
        
        // Check if selected event matches current filters
        const normalizedType = normalizeEventType(event.type);
        const venueGroup = getVenueGroup(event.venue);
        const isEvening = isEveningEvent(event.time);
        
        // Check if event matches type filter
        let matchesTypeFilter = typeFilter === 'all';
        if (typeFilter === 'daytime') {
          matchesTypeFilter = !isEvening;
        } else if (typeFilter === 'evening') {
          matchesTypeFilter = isEvening;
        } else if (typeFilter !== 'all') {
          matchesTypeFilter = normalizedType === typeFilter;
        }
        
        // Check if event matches venue filter
        const matchesVenueFilter = venueFilter === 'all' || venueGroup === venueFilter;
        
        // Reset filters if event doesn't match
        if (!matchesTypeFilter) {
          setTypeFilter('all');
        }
        if (!matchesVenueFilter) {
          setVenueFilter('all');
        }
        
        setViewYear(d.getFullYear());
        setViewMonth(d.getMonth());
        setSelectedDate(d.getDate());
        setSearchQuery('');
        setShowSearchResults(false);
      };
      
      // Get active types using normalized types
      const activeVenueGroups = useMemo(() => {
        const s = new Set();
        events.forEach(e => s.add(getVenueGroup(e.venue)));
        return s;
      }, [events]);
      
      const activeTypes = useMemo(() => {
        const s = new Set();
        events.forEach(e => {
          const normalizedType = normalizeEventType(e.type);
          s.add(normalizedType);
        });
        return s;
      }, [events]);
      
      const hasDaytimeEvents = useMemo(() => events.some(e => !isEveningEvent(e.time)), [events]);
      const hasEveningEvents = useMemo(() => events.some(e => isEveningEvent(e.time)), [events]);
      
      const formatLastUpdated = (str) => {
        if (!str) return null;
        const d = new Date(str);
        const mins = Math.floor((new Date() - d) / 60000);
        if (mins < 60) return `${mins}m ago`;
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return `${hrs}h ago`;
        return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
      };
      
      const formatEventDate = (str) => {
        const d = new Date(str);
        return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
      };
      
      const getDayName = (date) => ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date(viewYear, viewMonth, date).getDay()];
      
      const getShortTitle = (title, maxLen = 16) => {
        const short = title.replace(/^The\s+/i, '').replace(/[:|].*$/, '').trim();
        return short.length > maxLen ? short.substring(0, maxLen - 1) + '‚Ä¶' : short;
      };
      
      const weeksNeeded = Math.ceil((startDay + daysInMonth) / 7);
      
      // Get event type counts for a specific time period (daytime or evening)
      const getEventTypeCountsByTime = (dateEvents, isEvening) => {
        const counts = {};
        dateEvents.forEach(e => {
          const eventIsEvening = isEveningEvent(e.time);
          if (eventIsEvening === isEvening) {
            const type = normalizeEventType(e.type);
            counts[type] = (counts[type] || 0) + 1;
          }
        });
        return counts;
      };
      
      // Render event type shapes from counts
      const renderEventShapes = (typeCounts) => {
        const typeOrder = ['show', 'workshop', 'jam', 'dropin'];
        const shapes = [];
        
        typeOrder.forEach(type => {
          if (typeCounts[type]) {
            const count = typeCounts[type];
            const style = eventTypeStyles[type] || { color: colors.navy };
            shapes.push({
              type,
              count,
              color: style.color
            });
          }
        });
        
        // Max 4 shapes
        return shapes.slice(0, 4);
      };
      
      // Render a single shape for mobile
      const renderMobileShape = (shape, index) => {
        const { type, count, color } = shape;
        
        switch(type) {
          case 'show':
            return (
              <div key={index} className="mobile-shape-wrap">
                <div className="mobile-circle" style={{ background: color }}>
                  {count > 1 && <span className="shape-count">{count}</span>}
                </div>
              </div>
            );
          case 'workshop':
            return (
              <div key={index} className="mobile-shape-wrap">
                <div className="mobile-square" style={{ background: color }}>
                  {count > 1 && <span className="shape-count">{count}</span>}
                </div>
              </div>
            );
          case 'jam':
            return (
              <div key={index} className="mobile-shape-wrap">
                <div className="mobile-diamond" style={{ background: color }}>
                  <span>{count > 1 ? <span className="shape-count">{count}</span> : ''}</span>
                </div>
              </div>
            );
          case 'dropin':
            return (
              <div key={index} className="mobile-triangle-wrap">
                <div className="mobile-triangle" style={{ background: color }}></div>
                {count > 1 && <span className="mobile-triangle-num">{count}</span>}
              </div>
            );
          default:
            return (
              <div key={index} className="mobile-shape-wrap">
                <div className="mobile-circle" style={{ background: color }}>
                  {count > 1 && <span className="shape-count">{count}</span>}
                </div>
              </div>
            );
        }
      };
      
      const renderDays = () => {
        const days = [];
        for (let i = 0; i < startDay; i++) {
          days.push(<div key={`e-${i}`} className="cal-day empty"></div>);
        }
        for (let date = 1; date <= daysInMonth; date++) {
          const dateEvents = getEventsForDate(date);
          const hasEvents = dateEvents.length > 0;
          const isSelected = selectedDate === date;
          const dayIdx = (startDay + date - 1) % 7;
          const isWeekend = dayIdx >= 5;
          const isToday = viewYear === todayYear && viewMonth === todayMonth && date === todayDate;
          
          // Get shapes for daytime and evening separately
          const daytimeCounts = getEventTypeCountsByTime(dateEvents, false);
          const eveningCounts = getEventTypeCountsByTime(dateEvents, true);
          const daytimeShapes = renderEventShapes(daytimeCounts);
          const eveningShapes = renderEventShapes(eveningCounts);
          
          // Render chip shape for desktop view
          const renderChipShape = (type, color) => {
            switch(type) {
              case 'show':
                return <div className="chip-shape-wrap"><div className="chip-circle" style={{ background: color }}></div></div>;
              case 'workshop':
                return <div className="chip-shape-wrap"><div className="chip-square" style={{ background: color }}></div></div>;
              case 'jam':
                return <div className="chip-shape-wrap"><div className="chip-diamond" style={{ background: color }}></div></div>;
              case 'dropin':
                return <div className="chip-triangle-wrap"><div className="chip-triangle" style={{ background: color }}></div></div>;
              default:
                return <div className="chip-shape-wrap"><div className="chip-circle" style={{ background: color }}></div></div>;
            }
          };
          
          days.push(
            <div
              key={date}
              className={`cal-day ${hasEvents ? 'has-events' : ''} ${isSelected ? 'selected' : ''} ${isWeekend ? 'weekend' : ''} ${isToday ? 'today' : ''}`}
              onClick={() => hasEvents && setSelectedDate(isSelected ? null : date)}
            >
              <span className={`date-num ${isToday ? 'today-num' : ''}`}>{date}</span>
              {hasEvents && (
                <div className="event-previews">
                  {/* Desktop: show event titles with shapes */}
                  <div className="desktop-events">
                    {dateEvents.slice(0, 3).map((e, i) => {
                      const normalizedType = normalizeEventType(e.type);
                      const typeStyle = eventTypeStyles[normalizedType] || eventTypeStyles.show;
                      return (
                        <div key={i} className="event-chip" style={{ background: `${typeStyle.color}18`, borderColor: typeStyle.color }}>
                          {renderChipShape(normalizedType, typeStyle.color)}
                          <span className="chip-title">{getShortTitle(e.title)}</span>
                        </div>
                      );
                    })}
                    {dateEvents.length > 3 && <span className="more">+{dateEvents.length - 3} more</span>}
                  </div>
                  {/* Mobile: two-zone layout (daytime top, evening bottom) */}
                  <div className="mobile-events">
                    <div className="mobile-time-zone daytime">
                      {daytimeShapes.slice(0, 2).map((shape, i) => renderMobileShape(shape, `day-${i}`))}
                      {daytimeShapes.length > 2 && <span className="mobile-more">+</span>}
                    </div>
                    <div className="mobile-time-zone evening">
                      {eveningShapes.slice(0, 2).map((shape, i) => renderMobileShape(shape, `eve-${i}`))}
                      {eveningShapes.length > 2 && <span className="mobile-more">+</span>}
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }
        return days;
      };
      
      const selectedEvents = selectedDate ? getEventsForDate(selectedDate) : [];
      
      // Color key component with shapes
      const ColorKey = () => {
        const renderKeyShape = (type, color) => {
          switch(type) {
            case 'show':
              return <div className="key-shape"><div className="shape-circle" style={{ background: color }}></div></div>;
            case 'workshop':
              return <div className="key-shape"><div className="shape-square" style={{ background: color }}></div></div>;
            case 'jam':
              return <div className="shape-diamond-wrap"><div className="shape-diamond" style={{ background: color }}></div></div>;
            case 'dropin':
              return <div className="shape-triangle-wrap"><div className="shape-triangle" style={{ background: color }}></div></div>;
            default:
              return <div className="key-shape"><div className="shape-circle" style={{ background: color }}></div></div>;
          }
        };
        
        return (
          <div className="color-key">
            <span className="key-label">Key:</span>
            {Object.entries(eventTypeStyles).map(([type, style]) => (
              <div key={type} className="key-item">
                {renderKeyShape(type, style.color)}
                <span className="key-text">{style.label}</span>
              </div>
            ))}
          </div>
        );
      };
      
      return (
        <div className="app">
          <style>{`
            .app {
              display: flex;
              flex-direction: column;
              height: 100vh;
              background: ${colors.bg};
              font-family: 'Nunito', sans-serif;
              color: ${colors.text};
              overflow: hidden;
              position: relative;
            }
            
            /* BETA CORNER RIBBON */
            .beta-ribbon {
              position: absolute;
              top: 0;
              left: 0;
              width: 85px;
              height: 85px;
              overflow: hidden;
              z-index: 100;
              pointer-events: none;
            }
            .beta-ribbon span {
              position: absolute;
              display: block;
              width: 120px;
              padding: 4px 0;
              background: ${colors.terracotta};
              color: white;
              font-size: 0.55rem;
              font-weight: 800;
              text-transform: uppercase;
              text-align: center;
              letter-spacing: 0.1em;
              left: -35px;
              top: 22px;
              transform: rotate(-45deg);
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            
            /* HEADER - Always uses light mode colors */
            .header {
              background: #3D405B;
              padding: 0.6rem 1rem;
              display: flex;
              align-items: center;
              justify-content: space-between;
              gap: 0.75rem;
              flex-shrink: 0;
            }
            .header-left {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              min-width: 0;
            }
            .header h1 {
              font-size: 1.4rem;
              font-weight: 800;
              color: #F4F1DE;
              white-space: nowrap;
              line-height: 1.1;
            }
            .beta {
              background: ${colors.terracotta};
              color: white;
              font-size: 0.6rem;
              font-weight: 700;
              padding: 0.2rem 0.45rem;
              border-radius: 4px;
              text-transform: uppercase;
              flex-shrink: 0;
            }
            .header-center {
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            .nav-btn {
              background: transparent;
              border: 2px solid #F4F1DE40;
              color: #F4F1DE;
              width: 32px;
              height: 32px;
              border-radius: 6px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1rem;
              transition: all 0.15s;
            }
            .nav-btn:hover:not(:disabled) { background: #F4F1DE15; border-color: #F4F1DE; }
            .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
            .month-label {
              font-size: 0.9rem;
              font-weight: 600;
              color: ${colors.sage};
              text-transform: uppercase;
              letter-spacing: 0.08em;
              min-width: 110px;
              text-align: center;
            }
            .month-full { display: inline; }
            .month-short { display: none; }
            .today-btn {
              font-size: 0.65rem;
              font-weight: 700;
              padding: 0.35rem 0.6rem;
              background: ${colors.sage};
              color: white;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              text-transform: uppercase;
            }
            .today-btn:disabled { opacity: 0.4; cursor: not-allowed; }
            .settings-btn {
              font-size: 0.75rem;
              font-weight: 600;
              padding: 0.4rem 0.7rem;
              background: transparent;
              border: 2px solid #F4F1DE40;
              color: #F4F1DE;
              border-radius: 6px;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 0.35rem;
              white-space: nowrap;
            }
            .settings-btn:hover { background: #F4F1DE15; border-color: #F4F1DE; }
            
            /* CONTROLS */
            .controls {
              background: ${colors.cardBg};
              border-bottom: 2px solid ${colors.border};
              padding: 0.6rem 0.75rem;
              display: flex;
              flex-wrap: wrap;
              gap: 0.5rem;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              position: relative;
            }
            .controls-inner {
              display: flex;
              gap: 0.5rem;
              align-items: center;
              justify-content: center;
              position: relative;
              width: 100%;
              max-width: 650px;
            }
            .search-box {
              position: static;
              width: 200px;
              flex-shrink: 0;
            }
            .search-input {
              width: 100%;
              padding: 0.45rem 0.6rem 0.45rem 2rem;
              border: 2px solid ${colors.border};
              border-radius: 18px;
              font-size: 0.85rem;
              font-family: inherit;
              color: ${colors.text};
              background: ${colors.cardBg};
            }
            .search-input:focus { outline: none; border-color: ${colors.terracotta}; }
            .search-icon {
              position: absolute;
              left: 0.7rem;
              top: 50%;
              transform: translateY(-50%);
              font-size: 0.8rem;
              pointer-events: none;
            }
            .search-results {
              position: absolute;
              top: 100%;
              left: 0;
              right: 0;
              background: ${colors.cardBg};
              border-radius: 10px;
              box-shadow: 0 4px 20px rgba(0,0,0,0.15);
              margin-top: 4px;
              z-index: 100;
              max-height: 320px;
              overflow-y: auto;
            }
            .search-item {
              padding: 0.75rem 0.9rem;
              cursor: pointer;
              border-bottom: 1px solid ${colors.border};
            }
            .search-item:hover { background: ${colors.cream}; }
            .search-item:last-child { border-bottom: none; }
            .search-title { font-size: 0.9rem; font-weight: 600; color: ${colors.text}; }
            .search-meta { font-size: 0.8rem; color: ${colors.textMuted}; margin-top: 0.15rem; }
            
            .filter-select {
              font-family: inherit;
              font-size: 0.85rem;
              font-weight: 600;
              padding: 0.45rem 1.8rem 0.45rem 0.7rem;
              border: 2px solid ${colors.border};
              border-radius: 8px;
              background: ${colors.cardBg} url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='${darkMode ? '%23E8E8E8' : '%233D405B'}' d='M2 4l4 4 4-4H2z'/%3E%3C/svg%3E") no-repeat right 0.6rem center;
              color: ${colors.text};
              cursor: pointer;
              appearance: none;
              flex: 1;
              min-width: 0;
            }
            .filter-select:focus { outline: none; border-color: ${colors.terracotta}; }
            .filter-select.active { border-color: ${colors.terracotta}; background-color: ${colors.terracotta}10; }
            
            /* COLOR KEY */
            .color-key {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 1rem;
              padding: 0.4rem 0.75rem;
              background: ${colors.cardBg};
              border-bottom: 2px solid ${colors.border};
              flex-shrink: 0;
            }
            .key-label {
              font-size: 0.75rem;
              font-weight: 700;
              color: ${colors.textMuted};
              text-transform: uppercase;
              letter-spacing: 0.05em;
            }
            .key-item {
              display: flex;
              align-items: center;
              gap: 0.35rem;
            }
            .key-shape {
              width: 14px;
              height: 14px;
              flex-shrink: 0;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .key-text {
              font-size: 0.8rem;
              font-weight: 600;
              color: ${colors.text};
            }
            
            /* Shape definitions for key */
            .shape-circle {
              width: 100%;
              height: 100%;
              border-radius: 50%;
            }
            .shape-square {
              width: 100%;
              height: 100%;
              border-radius: 3px;
            }
            .shape-diamond-wrap {
              width: 14px;
              height: 14px;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .shape-diamond {
              width: 11px;
              height: 11px;
              border-radius: 2px;
              transform: rotate(45deg);
            }
            /* Rounded Triangle CSS - Source: https://stackoverflow.com/a/14451916, License: CC BY-SA 3.0 */
            .shape-triangle-wrap {
              width: 14px;
              height: 14px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
            }
            .shape-triangle {
              position: relative;
              text-align: left;
            }
            .shape-triangle:before,
            .shape-triangle:after {
              content: '';
              position: absolute;
              background-color: inherit;
            }
            .shape-triangle,
            .shape-triangle:before,
            .shape-triangle:after {
              width: 8px;
              height: 8px;
              border-top-right-radius: 30%;
            }
            .shape-triangle {
              transform: rotate(-60deg) skewX(-30deg) scale(1,.866);
            }
            .shape-triangle:before {
              transform: rotate(-135deg) skewX(-45deg) scale(1.414,.707) translate(0,-50%);
            }
            .shape-triangle:after {
              transform: rotate(135deg) skewY(-45deg) scale(.707,1.414) translate(50%);
            }
            
            /* MAIN LAYOUT */
            .main {
              display: flex;
              flex: 1;
              overflow: hidden;
              min-height: 0;
            }
            
            /* CALENDAR */
            .calendar {
              flex: 1;
              display: flex;
              flex-direction: column;
              overflow: hidden;
            }
            .cal-grid {
              display: grid;
              grid-template-columns: repeat(7, 1fr);
              grid-template-rows: auto repeat(${weeksNeeded}, 1fr);
              gap: 4px;
              padding: 0.5rem;
              flex: 1;
              min-height: 0;
            }
            .day-hdr {
              font-size: 0.8rem;
              font-weight: 700;
              text-align: center;
              padding: 0.4rem 0;
              color: ${colors.textMuted};
              text-transform: uppercase;
            }
            .cal-day {
              background: ${colors.cardBg};
              border-radius: 6px;
              padding: 0.35rem;
              display: flex;
              flex-direction: column;
              border: 2px solid transparent;
              overflow: visible;
              min-height: 0;
            }
            .cal-day.empty { background: transparent; border: none; }
            .cal-day.weekend { background: ${darkMode ? '#2F3244' : '#fffdf8'}; }
            .cal-day.today { border-color: ${colors.terracotta}50; background: ${colors.terracotta}15; }
            .cal-day.has-events { cursor: pointer; }
            .cal-day.has-events:hover { border-color: ${colors.sage}; transform: scale(1.02); z-index: 1; }
            .cal-day.selected { border-color: ${colors.terracotta}; box-shadow: 0 2px 8px ${colors.terracotta}30; z-index: 2; }
            .date-num {
              font-size: 0.9rem;
              font-weight: 700;
              color: ${colors.textMuted};
              margin-bottom: 0.25rem;
              flex-shrink: 0;
            }
            .has-events .date-num { color: ${colors.text}; }
            .date-num.today-num { color: ${colors.terracotta}; }
            
            .event-previews {
              flex: 1;
              overflow: hidden;
              display: flex;
              flex-direction: column;
              gap: 3px;
            }
            
            /* Desktop events - show titles */
            .desktop-events {
              display: flex;
              flex-direction: column;
              gap: 3px;
            }
            .event-chip {
              display: flex;
              align-items: center;
              gap: 4px;
              padding: 3px 5px;
              border-radius: 4px;
              border-left: 3px solid;
              overflow: hidden;
            }
            /* Desktop chip shapes */
            .chip-shape-wrap {
              width: 8px;
              height: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
            }
            .chip-circle {
              width: 8px;
              height: 8px;
              border-radius: 50%;
            }
            .chip-square {
              width: 8px;
              height: 8px;
              border-radius: 2px;
            }
            .chip-diamond {
              width: 6px;
              height: 6px;
              border-radius: 1px;
              transform: rotate(45deg);
            }
            .chip-triangle-wrap {
              width: 8px;
              height: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
            }
            .chip-triangle {
              position: relative;
              text-align: left;
            }
            .chip-triangle:before,
            .chip-triangle:after {
              content: '';
              position: absolute;
              background-color: inherit;
            }
            .chip-triangle,
            .chip-triangle:before,
            .chip-triangle:after {
              width: 5px;
              height: 5px;
              border-top-right-radius: 30%;
            }
            .chip-triangle {
              transform: rotate(-60deg) skewX(-30deg) scale(1,.866);
            }
            .chip-triangle:before {
              transform: rotate(-135deg) skewX(-45deg) scale(1.414,.707) translate(0,-50%);
            }
            .chip-triangle:after {
              transform: rotate(135deg) skewY(-45deg) scale(.707,1.414) translate(50%);
            }
            .chip-title {
              font-size: 0.7rem;
              font-weight: 600;
              color: ${colors.text};
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }
            
            /* Mobile events - two-zone layout (daytime top, evening bottom) */
            .mobile-events {
              display: none;
              flex-direction: column;
              flex: 1;
              min-height: 24px;
            }
            .mobile-time-zone {
              flex: 1;
              display: flex;
              flex-wrap: wrap;
              gap: 2px;
              align-items: flex-start;
              align-content: flex-start;
              min-height: 12px;
            }
            .mobile-time-zone.evening {
              align-items: flex-end;
              align-content: flex-end;
            }
            
            /* Mobile "more" indicator when there are too many shapes */
            .mobile-more {
              font-size: 0.55rem;
              font-weight: 700;
              color: ${colors.textMuted};
              line-height: 1;
              padding: 0 1px;
            }
            
            /* Mobile shape wrapper - consistent sizing */
            .mobile-shape-wrap {
              width: 12px;
              height: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              position: relative;
            }
            
            /* Mobile Circle (Shows) */
            .mobile-circle {
              width: 12px;
              height: 12px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            
            /* Mobile Rounded Square (Workshops) */
            .mobile-square {
              width: 12px;
              height: 12px;
              border-radius: 3px;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            
            /* Mobile Rounded Diamond (Jams) */
            .mobile-diamond {
              width: 9px;
              height: 9px;
              border-radius: 2px;
              transform: rotate(45deg);
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .mobile-diamond span {
              transform: rotate(-45deg);
            }
            
            /* Mobile Rounded Triangle (Drop-ins) - Source: https://stackoverflow.com/a/14451916, License: CC BY-SA 3.0 */
            .mobile-triangle-wrap {
              width: 12px;
              height: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
            }
            .mobile-triangle {
              position: relative;
              text-align: left;
            }
            .mobile-triangle:before,
            .mobile-triangle:after {
              content: '';
              position: absolute;
              background-color: inherit;
            }
            .mobile-triangle,
            .mobile-triangle:before,
            .mobile-triangle:after {
              width: 7px;
              height: 7px;
              border-top-right-radius: 30%;
            }
            .mobile-triangle {
              transform: rotate(-60deg) skewX(-30deg) scale(1,.866);
            }
            .mobile-triangle:before {
              transform: rotate(-135deg) skewX(-45deg) scale(1.414,.707) translate(0,-50%);
            }
            .mobile-triangle:after {
              transform: rotate(135deg) skewY(-45deg) scale(.707,1.414) translate(50%);
            }
            .mobile-triangle-num {
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -35%);
              font-size: 0.4rem;
              font-weight: 700;
              color: white;
              z-index: 10;
            }
            
            .shape-count {
              font-size: 0.4rem;
              font-weight: 700;
              color: white;
              line-height: 1;
            }
            
            .more { font-size: 0.65rem; color: ${colors.textMuted}; padding: 2px; }
            
            /* DETAIL PANEL - DESKTOP */
            .detail {
              width: 340px;
              background: ${colors.cardBg};
              border-left: 3px solid ${colors.border};
              overflow-y: auto;
              flex-shrink: 0;
              display: flex;
              flex-direction: column;
            }
            .detail-inner { padding: 1rem; flex: 1; }
            .detail-hdr {
              font-size: 1.15rem;
              font-weight: 700;
              color: ${colors.terracotta};
              margin-bottom: 0.75rem;
              padding-bottom: 0.5rem;
              border-bottom: 2px solid ${colors.border};
            }
            .event-card {
              display: block;
              background: ${colors.cream};
              border-radius: 10px;
              padding: 0.9rem;
              margin-bottom: 0.7rem;
              text-decoration: none;
              color: inherit;
              border-left: 4px solid;
              transition: transform 0.15s;
            }
            .event-card:hover { transform: translateX(3px); }
            .event-row { display: flex; gap: 0.7rem; }
            .event-icon { font-size: 1.5rem; }
            .event-info { flex: 1; min-width: 0; }
            .event-title { font-size: 0.95rem; font-weight: 700; margin-bottom: 0.3rem; }
            .event-meta { font-size: 0.85rem; color: ${colors.textMuted}; }
            .event-meta span { display: block; }
            .event-cta { font-size: 0.8rem; font-weight: 700; color: ${colors.terracotta}; margin-top: 0.5rem; }
            .no-select {
              display: flex;
              align-items: center;
              justify-content: center;
              text-align: center;
              padding: 1rem;
              color: ${colors.textMuted};
              font-size: 0.95rem;
            }
            .clash { background: ${colors.sand}40; border: 2px solid ${colors.sand}; border-radius: 8px; padding: 0.55rem 0.7rem; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.7rem; }
            
            /* FOOTER */
            .kofi-bar {
              background: linear-gradient(135deg, ${colors.sage}20, ${colors.sand}30);
              border-top: 2px solid ${colors.border};
              padding: 0.55rem 1rem;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 0.7rem;
              flex-shrink: 0;
            }
            .kofi-text { font-size: 0.85rem; font-weight: 600; color: ${colors.text}; }
            .kofi-btn {
              display: inline-flex;
              align-items: center;
              gap: 0.35rem;
              background: #FF5E5B;
              color: white;
              padding: 0.4rem 0.8rem;
              border-radius: 6px;
              font-size: 0.8rem;
              font-weight: 700;
              text-decoration: none;
            }
            .kofi-btn:hover { transform: scale(1.05); }
            .footer {
              background: ${colors.cream};
              border-top: 2px solid ${colors.border};
              padding: 0.75rem 1rem;
              text-align: center;
              font-size: 0.9rem;
              flex-shrink: 0;
            }
            .footer-text { color: ${colors.text}; font-weight: 600; }
            .footer a { 
              color: ${colors.terracotta}; 
              font-weight: 700; 
              text-decoration: none;
              padding: 0.3rem 0.6rem;
              background: ${colors.terracotta}15;
              border-radius: 4px;
              margin-left: 0.3rem;
            }
            .footer a:hover { background: ${colors.terracotta}25; }
            .footer-updated { color: ${colors.textMuted}; margin-left: 0.5rem; font-size: 0.8rem; }
            
            /* LOADING */
            .loading {
              flex: 1;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              gap: 0.75rem;
              color: ${colors.textMuted};
            }
            .spinner {
              width: 40px;
              height: 40px;
              border: 4px solid ${colors.border};
              border-top-color: ${colors.terracotta};
              border-radius: 50%;
              animation: spin 1s linear infinite;
            }
            @keyframes spin { to { transform: rotate(360deg); } }
            
            /* MODAL */
            .modal-overlay {
              position: fixed;
              inset: 0;
              background: rgba(0,0,0,0.75);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 1000;
              padding: 1rem;
            }
            .modal-content {
              background: ${colors.cardBg};
              border-radius: 14px;
              max-width: 540px;
              width: 100%;
              max-height: 90vh;
              overflow: hidden;
              display: flex;
              flex-direction: column;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }
            .modal-header {
              background: ${darkMode ? '#1A1C28' : colors.navy};
              color: ${darkMode ? '#E8E8E8' : colors.cream};
              padding: 1rem 1.25rem;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            .modal-header h2 { font-size: 1.2rem; margin: 0; }
            .modal-close { background: none; border: none; color: ${darkMode ? '#E8E8E8' : colors.cream}; font-size: 1.2rem; cursor: pointer; opacity: 0.7; }
            .modal-close:hover { opacity: 1; }
            .modal-body { padding: 1.25rem; overflow-y: auto; flex: 1; }
            .roadmap-intro { font-size: 0.9rem; color: ${colors.textMuted}; margin-bottom: 1.25rem; line-height: 1.5; }
            .roadmap-section { margin-bottom: 1.5rem; }
            .roadmap-section h3 { font-size: 1rem; font-weight: 700; margin-bottom: 0.6rem; padding-bottom: 0.4rem; border-bottom: 2px solid ${colors.border}; color: ${colors.text}; }
            .roadmap-section ul { list-style: none; }
            .roadmap-cta { background: ${colors.cream}; border-radius: 10px; padding: 1rem; text-align: center; margin-top: 0.5rem; }
            .roadmap-cta p { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.6rem; }
            .roadmap-cta .cta-note { font-size: 0.75rem; color: ${colors.textMuted}; margin-top: 0.5rem; margin-bottom: 0; }
            .cta-button { display: inline-block; background: ${colors.terracotta}; color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; font-weight: 700; text-decoration: none; }
            .cta-button:hover { transform: scale(1.03); }
            
            /* Settings Modal */
            .settings-modal { max-width: 380px; }
            .settings-section {
              padding: 0.75rem 0;
              border-bottom: 1px solid ${colors.border};
            }
            .settings-section:last-of-type { border-bottom: none; }
            .settings-row {
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .settings-label {
              display: flex;
              align-items: center;
              gap: 0.6rem;
              font-size: 0.95rem;
              font-weight: 600;
              color: ${colors.text};
            }
            .settings-icon { font-size: 1.1rem; }
            
            /* Toggle Button */
            .toggle-btn {
              width: 52px;
              height: 28px;
              background: ${darkMode ? '#4A4D5E' : colors.navy + '30'};
              border: none;
              border-radius: 14px;
              cursor: pointer;
              position: relative;
              transition: background 0.2s;
            }
            .toggle-btn.active { background: ${colors.sage}; }
            .toggle-slider {
              position: absolute;
              top: 3px;
              left: 3px;
              width: 22px;
              height: 22px;
              background: white;
              border-radius: 50%;
              transition: transform 0.2s;
              box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }
            .toggle-btn.active .toggle-slider { transform: translateX(24px); }
            
            /* Settings Link Button */
            .settings-link-btn {
              width: 100%;
              display: flex;
              align-items: center;
              gap: 0.6rem;
              padding: 0.6rem 0.5rem;
              background: transparent;
              border: none;
              font-size: 0.95rem;
              font-weight: 600;
              color: ${colors.text};
              cursor: pointer;
              border-radius: 8px;
              transition: background 0.15s;
            }
            .settings-link-btn:hover { background: ${colors.cream}; }
            .settings-arrow { margin-left: auto; color: ${colors.textMuted}; }
            
            /* Settings CTA */
            .settings-cta {
              text-align: center;
              padding-top: 1rem !important;
            }
            .settings-cta-text {
              font-size: 0.9rem;
              color: ${colors.textMuted};
              margin-bottom: 0.75rem;
            }
            
            /* Settings Footer */
            .settings-footer {
              padding-top: 1rem;
              margin-top: 0.5rem;
              border-top: 1px solid ${colors.border};
              text-align: center;
            }
            .settings-updated {
              font-size: 0.75rem;
              color: ${colors.textMuted};
            }
            
            /* ============================================
               MOBILE STYLES
               ============================================ */
            @media (max-width: 768px) {
              /* Beta ribbon - smaller on mobile */
              .beta-ribbon {
                width: 70px;
                height: 70px;
              }
              .beta-ribbon span {
                width: 100px;
                padding: 3px 0;
                font-size: 0.5rem;
                left: -28px;
                top: 18px;
              }
              
              /* Hide inline beta badge on mobile */
              .beta { display: none; }
              
              /* Vertical stack layout */
              .main { flex-direction: column; }
              
              /* Calendar - height based on weeks needed */
              .calendar {
                flex: none;
                height: 48vh;
                min-height: 240px;
              }
              
              /* 6-week months need more height */
              .calendar.six-weeks {
                height: 55vh;
                min-height: 290px;
              }
              
              /* Bottom panel - when NO selection, auto height (compact) */
              .detail.no-selection {
                flex: none;
                height: auto;
                overflow: visible;
              }
              
              /* Bottom panel - when HAS selection, fill remaining and scroll */
              .detail.has-selection {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
              }
              
              .detail {
                width: 100%;
                border-left: none;
                border-top: 3px solid ${colors.border};
              }
              
              /* Compact no-select message */
              .no-select {
                padding: 0.4rem;
                font-size: 0.75rem;
              }
              
              /* Mobile footer styling */
              .mobile-footer .kofi-bar {
                padding: 0.4rem 0.6rem;
                gap: 0.4rem;
                flex-wrap: wrap;
              }
              .mobile-footer .kofi-text { font-size: 0.7rem; }
              .mobile-footer .kofi-btn { font-size: 0.65rem; padding: 0.3rem 0.55rem; }
              .mobile-footer .footer { font-size: 0.8rem; padding: 0.6rem 0.5rem; }
              .mobile-footer .footer a { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
              
              /* Hide desktop footer on mobile */
              .desktop-footer { display: none; }
              
              /* Header adjustments */
              .header {
                padding: 0.5rem 0.6rem;
                padding-left: 2.5rem;
                gap: 0.4rem;
              }
              .header h1 {
                font-size: 1rem;
                white-space: normal;
                line-height: 1.15;
              }
              .header-left { gap: 0.35rem; }
              .month-full { display: none; }
              .month-short { display: inline; }
              .month-label { min-width: 75px; font-size: 0.75rem; }
              .nav-btn { width: 28px; height: 28px; font-size: 0.9rem; }
              .today-btn { font-size: 0.55rem; padding: 0.3rem 0.45rem; }
              .settings-btn { padding: 0.3rem 0.45rem; font-size: 0.65rem; }
              .settings-btn span { display: none; }
              
              /* Controls */
              .controls { padding: 0.45rem 0.5rem; }
              .controls-inner { gap: 0.4rem; flex-wrap: nowrap; }
              .search-box { width: auto; flex: 1; min-width: 70px; }
              .search-input { padding: 0.35rem 0.45rem 0.35rem 1.6rem; font-size: 0.75rem; }
              .search-icon { font-size: 0.7rem; left: 0.55rem; }
              .filter-select { font-size: 0.75rem; padding: 0.35rem 1.4rem 0.35rem 0.45rem; flex: 1; }
              
              /* Color key - mobile */
              .color-key {
                padding: 0.3rem 0.5rem;
                gap: 0.5rem;
                flex-wrap: wrap;
              }
              .key-label { font-size: 0.65rem; }
              .key-shape { width: 10px; height: 10px; }
              .shape-diamond-wrap { width: 10px; height: 10px; }
              .shape-diamond { width: 8px; height: 8px; }
              .shape-triangle-wrap { width: 10px; height: 10px; }
              .shape-triangle,
              .shape-triangle:before,
              .shape-triangle:after { width: 6px; height: 6px; }
              .key-text { font-size: 0.7rem; }
              
              /* Calendar grid */
              .cal-grid { 
                padding: 0.35rem; 
                gap: 3px;
                grid-template-rows: auto repeat(${weeksNeeded}, minmax(48px, 1fr));
              }
              .day-hdr { font-size: 0.7rem; padding: 0.3rem 0; }
              .cal-day { padding: 0.25rem; border-radius: 5px; min-height: 48px; }
              .date-num { font-size: 0.75rem; margin-bottom: 0.1rem; }
              
              /* 6-week months - allow calendar to scroll */
              .cal-grid.weeks-6 { 
                grid-template-rows: auto repeat(6, minmax(44px, 1fr));
              }
              .cal-grid.weeks-6 .cal-day { min-height: 44px; }
              .cal-grid.weeks-6 .mobile-time-zone { min-height: 11px; }
              
              /* Show mobile shapes, hide desktop events */
              .desktop-events { display: none; }
              .mobile-events { display: flex; }
              
              /* Two-zone layout adjustments for mobile */
              .mobile-time-zone { min-height: 14px; }
              
              /* Detail panel content */
              .detail-hdr { font-size: 1rem; margin-bottom: 0.5rem; padding-bottom: 0.4rem; }
              .detail-inner { padding: 0.75rem; }
              .event-card { padding: 0.75rem; margin-bottom: 0.5rem; }
              .event-icon { font-size: 1.3rem; }
              .event-title { font-size: 0.9rem; }
              .event-meta { font-size: 0.8rem; }
              .event-cta { font-size: 0.75rem; }
              .clash { font-size: 0.8rem; padding: 0.45rem 0.55rem; margin-bottom: 0.5rem; }
            }
            
            @media (max-width: 380px) {
              .header h1 { font-size: 0.9rem; }
              .filter-select { font-size: 0.7rem; padding: 0.3rem 1.3rem 0.3rem 0.4rem; }
              .mobile-shape-wrap { width: 10px; height: 10px; }
              .mobile-circle { width: 10px; height: 10px; }
              .mobile-square { width: 10px; height: 10px; border-radius: 2px; }
              .mobile-diamond { width: 8px; height: 8px; }
              .mobile-triangle-wrap { width: 10px; height: 10px; }
              .mobile-triangle,
              .mobile-triangle:before,
              .mobile-triangle:after { width: 6px; height: 6px; }
              .mobile-triangle-num { font-size: 0.4rem; }
              .shape-count { font-size: 0.4rem; }
              .color-key { gap: 0.4rem; }
              .key-item { gap: 0.25rem; }
              .key-shape { width: 8px; height: 8px; }
              .shape-diamond-wrap { width: 8px; height: 8px; }
              .shape-diamond { width: 6px; height: 6px; }
              .shape-triangle-wrap { width: 8px; height: 8px; }
              .shape-triangle,
              .shape-triangle:before,
              .shape-triangle:after { width: 5px; height: 5px; }
              .key-text { font-size: 0.6rem; }
            }
            
            /* Desktop: show desktop footer, hide mobile footer, hide ribbon */
            @media (min-width: 769px) {
              .mobile-footer { display: none; }
              .beta-ribbon { display: none; }
            }
          `}</style>
          
          {/* Beta corner ribbon - mobile only */}
          <div className="beta-ribbon">
            <span>Beta</span>
          </div>
          
          <header className="header">
            <div className="header-left">
              <h1>Bristol Improv Calendar</h1>
              <span className="beta">Beta</span>
            </div>
            <div className="header-center">
              <button className="nav-btn" onClick={goToPrevMonth} disabled={!canGoBack}>‚Üê</button>
              <span className="month-label">
                <span className="month-full">{monthNames[viewMonth]} {viewYear}</span>
                <span className="month-short">{monthShort[viewMonth]} {viewYear}</span>
              </span>
              <button className="nav-btn" onClick={goToNextMonth} disabled={!canGoForward}>‚Üí</button>
              <button className="today-btn" onClick={goToToday} disabled={isCurrentMonth}>Today</button>
            </div>
            <button className="settings-btn" onClick={() => setShowSettings(true)}>
              ‚öôÔ∏è <span>Settings</span>
            </button>
          </header>
          
          {error && <div style={{ background: `${colors.sand}30`, textAlign: 'center', fontSize: '0.65rem', padding: '0.3rem', color: colors.text }}>‚ö†Ô∏è {error}</div>}
          
          {loading ? (
            <div className="loading">
              <div className="spinner"></div>
              <div>Loading events...</div>
            </div>
          ) : (
            <>
              <div className="controls" ref={controlsRef}>
                <div className="controls-inner">
                  <div className="search-box">
                    <span className="search-icon">üîç</span>
                    <input
                      type="text"
                      className="search-input"
                      placeholder="Search..."
                      value={searchQuery}
                      onChange={e => { setSearchQuery(e.target.value); setShowSearchResults(true); }}
                      onFocus={() => setShowSearchResults(true)}
                    />
                  </div>
                  <select 
                    className={`filter-select ${typeFilter !== 'all' ? 'active' : ''}`}
                    value={typeFilter}
                    onChange={e => setTypeFilter(e.target.value)}
                  >
                    <option value="all">All Events</option>
                    <option value="show" disabled={!activeTypes.has('show')}>‚óè Shows</option>
                    <option value="workshop" disabled={!activeTypes.has('workshop')}>‚ñ† Workshops</option>
                    <option value="jam" disabled={!activeTypes.has('jam')}>‚óÜ Jams</option>
                    <option value="dropin" disabled={!activeTypes.has('dropin')}>‚ñ≤ Drop-ins</option>
                    <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                    <option value="daytime" disabled={!hasDaytimeEvents}>‚òÄÔ∏è Daytime</option>
                    <option value="evening" disabled={!hasEveningEvents}>üåô Evening</option>
                  </select>
                  <select 
                    className={`filter-select ${venueFilter !== 'all' ? 'active' : ''}`}
                    value={venueFilter}
                    onChange={e => setVenueFilter(e.target.value)}
                  >
                    <option value="all">All Venues</option>
                    {venueGroups.map(({ key, label }) => (
                      <option key={key} value={key} disabled={!activeVenueGroups.has(key)}>{label}</option>
                    ))}
                  </select>
                  {showSearchResults && searchResults.length > 0 && (
                    <div className="search-results">
                      {searchResults.map((e, i) => (
                        <div key={i} className="search-item" onClick={() => handleSearchSelect(e)}>
                          <div className="search-title">{e.title}</div>
                          <div className="search-meta">{formatEventDate(e.date)} ‚Ä¢ {e.venue}</div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
              
              <ColorKey />
              
              <div className="main">
                <div 
                  className={`calendar ${weeksNeeded >= 6 ? 'six-weeks' : ''}`}
                  ref={calendarRef}
                  onTouchStart={handleTouchStart}
                  onTouchEnd={handleTouchEnd}
                >
                  <div className={`cal-grid weeks-${weeksNeeded}`}>
                    {dayNames.map(d => <div key={d} className="day-hdr">{d}</div>)}
                    {renderDays()}
                  </div>
                </div>
                
                <div className={`detail ${selectedDate ? 'has-selection' : 'no-selection'}`}>
                  {selectedDate ? (
                    <>
                      <div className="detail-inner">
                        <h3 className="detail-hdr">{getDayName(selectedDate)} {selectedDate} {monthShort[viewMonth]}</h3>
                        {selectedEvents.length > 1 && hasOverlappingEvents(selectedEvents) && (
                          <div className="clash">üé≠ {selectedEvents.length} events ‚Äî choose your favourite!</div>
                        )}
                        {selectedEvents.map((e, i) => {
                          const venueInfo = getVenueInfo(e.venue);
                          const normalizedType = normalizeEventType(e.type);
                          const typeStyle = eventTypeStyles[normalizedType] || eventTypeStyles.show;
                          return (
                            <a key={i} href={e.url} target="_blank" rel="noopener noreferrer" className="event-card" style={{ borderColor: typeStyle.color }}>
                              <div className="event-row">
                                <span className="event-icon">{typeStyle.icon}</span>
                                <div className="event-info">
                                  <div className="event-title">{e.title}</div>
                                  <div className="event-meta">
                                    <span>üìç {e.venue}</span>
                                    <span>üïñ {e.time}</span>
                                  </div>
                                  <div className="event-cta">View details / Book tickets ‚Üí</div>
                                </div>
                              </div>
                            </a>
                          );
                        })}
                      </div>
                      <div className="mobile-footer">
                        <div className="kofi-bar">
                          <span className="kofi-text">‚òï Find this useful? Buy Ste a brew! (...or a pint...)</span>
                          <a href={KOFI_URL} target="_blank" rel="noopener noreferrer" className="kofi-btn">‚ù§Ô∏è Support on Ko-fi</a>
                        </div>
                        <div className="footer">
                          <span className="footer-text">Missing a show? Got corrections?</span> <a href="https://forms.gle/62psP8V9JF88Kdnz8" target="_blank" rel="noopener noreferrer">Let us know</a>
                        </div>
                      </div>
                    </>
                  ) : (
                    <>
                      <div className="no-select">
                        üëà Click a date to see event details
                      </div>
                      <div className="mobile-footer">
                        <div className="kofi-bar">
                          <span className="kofi-text">‚òï Find this useful? Buy Ste a brew! (...or a pint...)</span>
                          <a href={KOFI_URL} target="_blank" rel="noopener noreferrer" className="kofi-btn">‚ù§Ô∏è Support on Ko-fi</a>
                        </div>
                        <div className="footer">
                          <span className="footer-text">Missing a show? Got corrections?</span> <a href="https://forms.gle/62psP8V9JF88Kdnz8" target="_blank" rel="noopener noreferrer">Let us know</a>
                        </div>
                      </div>
                    </>
                  )}
                </div>
              </div>
            </>
          )}
          
          {/* Desktop footer */}
          <div className="desktop-footer">
            <div className="kofi-bar">
              <span className="kofi-text">‚òï Find this useful? Buy Ste a brew! (...or a pint...)</span>
              <a href={KOFI_URL} target="_blank" rel="noopener noreferrer" className="kofi-btn">‚ù§Ô∏è Support on Ko-fi</a>
            </div>
            <div className="footer">
              <span className="footer-text">Missing a show? Got corrections?</span> <a href="https://forms.gle/62psP8V9JF88Kdnz8" target="_blank" rel="noopener noreferrer">Let us know</a>
              {lastUpdated && <span className="footer-updated">‚Ä¢ Updated {formatLastUpdated(lastUpdated)}</span>}
            </div>
          </div>
          
          <RoadmapModal isOpen={showRoadmap} onClose={() => setShowRoadmap(false)} colors={colors} />
          <SettingsModal 
            isOpen={showSettings} 
            onClose={() => setShowSettings(false)} 
            colors={colors}
            darkMode={darkMode}
            setDarkMode={setDarkMode}
            onOpenRoadmap={() => setShowRoadmap(true)}
            lastUpdated={lastUpdated}
            formatLastUpdated={formatLastUpdated}
          />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<BristolImprovCalendar />);
  </script>
</body>
</html>
